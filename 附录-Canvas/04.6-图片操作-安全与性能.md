# 04.6-图片操作 - 安全与性能

## 一 安全问题

图像操作经常会带来安全问题，如需要对图片进行加密以保持不外泄。所以 canvas 虽然允许绘制不属于自己域中的图像，但不能对齐进行保存与修改。

canvas 的绘图安全机制如下：

每个 canvas 都以一个名为`rigin-clean`的标志位，初始值为 true。如果使用`drawImage()`绘制了一幅其他域中的图像，那么`origin-clean`的值就会设置为 false，如果此时在该 canvas 上调用`toDataURL()`，`getImageData()`等方法，浏览器会抛出 `SECURITY_ERR` 异常。

贴士：canvas 会将用户的文件系统与运行程序所在的环境视为 2 个不同的域，所以默认不能保存修改文件系统中的图像。如果要绕过该阻碍，通过在命令行中指定 `--allow-file-access-from-files` 参数来启动 chrome 浏览器。这个参数会让浏览器绕开绘图安全机制，以让开发者保存、修改其他域中的图像。

## 二 性能问题

一般情况下，drawImage() 要比 putImageData() 快很多。

如果在绘制时还要对 canvas 进行缩放，则会更加耗时。

此外遍历图片的像素数据是极度耗时的，可以采取以下方法优化效率：

- 避免在循环体内直接访问对象属性，而是将其存放在局部变量中
- 应该用循环计数器的方式来遍历完整的像素，而非像素分量
- 逆向遍历与位移（bit-shifting）技巧的效果并不好。
- 不要频繁的调用 getImageData() 来获取少量数据

贴士：图像上护具每个像素都是 4 个 8 位二进制整数保存的，每个分量取值范围是 0-255，所以循环计数器每次进步都是像素个数的 4 倍。
